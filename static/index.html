<!DOCTYPE HTML>
<html>
<head>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</head>
<body>
<h1>Warning this website does not use HTTPS yet. Be careful with what you submit in the form</h1>
	
<div id="chartContainer" style="height: 370px; width:100%;"></div>
<p>Date: <input type="date" id="date" name="date" value="2023-03-18"></p>
<button onclick="getDataHandler('PlayerCount')">Get</button>

</body>
<script>
apiUrl = "/NCMetrics"
base = "https://landshark.name"
metricNameKey = "metricName"
startTimeKey = "startTime"
endTimeKey = "endTime"

var dps = []; // dataPoints
var chart = new CanvasJS.Chart("chartContainer", {
	title :{
		text: "NC Player Count"
	},
	data: [{
		type: "line",
		dataPoints: dps,
		xValueType: "dateTime"
	}]
});

chart.render()

var xVal = 0;
var yVal = 100;
var updateInterval = 1000;
var dataLength = 20; // number of dataPoints visible at any point

function buildURL(metricName, startTime, endTime) {
    url = new URL(apiUrl, base)
    query = new URLSearchParams()
    query.append(metricNameKey, metricName)
    query.append(startTimeKey, startTime)
    query.append(endTimeKey, endTime)

    return url.toString() + "?" + query.toString()
}

async function makeRequest(url) {
    request = new Request(url)
    response = await fetch(request)
    if(response.status === 200) {

        updateChart(await response.json())
    }
    else {
        console.log("error happened", response, response.text())
    }
}

function updateChart(response) {
    datapoints = response["data"].map(dp => {return {x: new Date(dp["time"]*1000), y:convertToNumber(dp["playerCount"])}});
    chart.options.data[0].dataPoints = datapoints;
	chart.render();
};

function convertToNumber(str) {
    const parsed = parseInt(str, 10)
    if (isNaN(parsed)) { return 0 }
    return parsed
}

async function getDataHandler(metricName) {
    startTime = new Date(document.getElementById("date").value+"T00:00")
    startTime = startTime.getTime()/1000
    url = buildURL(metricName, startTime, startTime + 24*60*60)
    await makeRequest(url)
}
</script>
</html>
